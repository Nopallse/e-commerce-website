<%- include("../layout/sidebar.ejs") %>

<!-- Content -->
<div class="w-full px-4 sm:px-6 md:px-8 lg:ps-72">
  <!-- your content goes here ... -->
  <!-- Card Section -->
  <div class="max-w-[85rem] px-4 py-4  sm:px-6 lg:px-8 mx-auto">
        <form id="permintaanForm" method="POST" action="/admin/verifikasi">
            <!-- Card -->
            <div class="bg-white rounded-xl shadow" style="margin: 40px;">
                
                <div class="relative h-20 rounded-t-xl bg-no-repeat bg-cover bg-center" style="background-color: #388E3C;">
                  <div class="text-center">
                    <br>
                    <h2 class="text-2xl md:text-3xl font-bold text-white">
                      Formulir Permintaan Surat Keterangan Aktif Kuliah
                    </h2>
                    <br>
                  </div>
                </div>
        
                <div  class="pt-0 p-4 sm:pt-0 sm:p-7">
                  <!-- Grid -->
                  <p style="display: none;" class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                  style="background-color:aliceblue;" name="idPermintaan" value="<%= permintaan.idPermintaan %>">
  
                  ID: <%= permintaan.idPermintaan %>
                </p>
                <input type="hidden" name="idPermintaan" value="<%= permintaan.idPermintaan %>">

                  <div class="space-y-4 sm:space-y-6">
                    <div class="space-y-2">
                      <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                        NAMA LENGKAP MAHASISWA/I
                      </label>
                      <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                        style="background-color:aliceblue;">
        
                        <%= mahasiswa.name %>
                      </p>
                    </div>
                    <div class="space-y-2">
                      <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                        NOMOR INDUK MAHASISWA (NIM)
                      </label>
                      <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                        style="background-color:aliceblue;">
        
                        <%= permintaan.nim %>
                      </p>
                    </div>
                    <div class="space-y-2">
                      <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                        DEPARTEMEN
                      </label>
                      <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                        style="background-color:aliceblue;">
        
                        <%= mahasiswa.departemen %>
                      </p>
                    </div>
                    <div class="space-y-2">
                      <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                        Target permintaan surat
                      </label>
                      <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                        style="background-color:aliceblue;">
        
                        <%= permintaan.target %>
                      </p>
                    </div>
                    <div class="space-y-2">
                      <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                        Tujuan permintaan surat
                      </label>
                      <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                        style="background-color:aliceblue;">
        
                        <%= permintaan.tujuan %>
                      </p>
                    </div>
        
                    <% if(permintaan.target !=='Pribadi' ) { %>
                      <div>
                        <div class="space-y-2">
                          <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NAMA ORANG TUA
                          </label>
                          <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                            style="background-color:aliceblue;">
        
                            <%= permintaan.namaOrangtua %>
                          </p>
                        </div>
                        <div class="space-y-2">
                          <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            NIP
                          </label>
                          <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                            style="background-color:aliceblue;">
        
                            <%= permintaan.nip %>
                          </p>
                        </div>
                        <div class="space-y-2">
                          <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            PANGKAT DAN GOLONGAN
                          </label>
                          <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                            style="background-color:aliceblue;">
        
                            <%= permintaan.pangkatGolongan %>
                          </p>
                        </div>
                        <div class="space-y-2">
                          <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            UNIT KERJA
                          </label>
                          <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                            style="background-color:aliceblue;">
        
                            <%= permintaan.unitKerja %>
                          </p>
                        </div>
                        <div class="space-y-2">
                          <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            INSTANSI INDUK
                          </label>
                          <p class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm rounded-lg text-sm text-gray-800"
                            style="background-color:aliceblue;">
        
                            <%= permintaan.instansiInduk %>
                          </p>
                        </div>
                      </div>
                      <% } %>
                    <div class="space-y-2" id="file">
                        <label for="inputFile" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
                            BERKAS (SK Terakhir Orang Tua dan KRS Terakhir)
                        </label>
                            <div class="mt-2">
                                <a class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:pointer-events-none" href="/data/permintaan/<%= permintaan.berkas %>" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                    Lihat Berkas
                                </a>
                            </div>                  
                    </div>
                    </div>
                    <!-- End Grid -->

                    <div class="mt-5 flex justify-center gap-x-2">
                        <button type="submit" id="submitButton" class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:pointer-events-none">
                            Verifikasi
                        </button>
                        <button type="button" id="rejectButton" class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:pointer-events-none">
                            Tolak
                        </button>
                        <div id="loadingIndicator" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8c0 .76 2.33 1.34 3.54 1.84m2.07.66a8 8 0 011.84 3.54M4.47 16.31a8 8 0 013.54-1.84m2.07-.66a8 8 0 018 8v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Card -->
        </form>
    </div>
    <!-- End Card Section -->
</div>

<!-- Modal -->
<div id="rejectModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
  <div class="flex items-center justify-center min-h-screen px-4">
    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
      <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
    </div>
    <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
      <div class="bg-white px-6 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Alasan Penolakan
            </h3>
            <div class="mt-3">
              <textarea 
                id="rejectReason" 
                name="rejectReason" 
                rows="4" 
                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md">
              </textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" id="confirmRejectButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
          Tolak
        </button>
        <button type="button" id="cancelRejectButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
          Batal
        </button>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('permintaanForm');
        const submitButton = document.getElementById('submitButton');
        const rejectButton = document.getElementById('rejectButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const rejectModal = document.getElementById('rejectModal');
        const confirmRejectButton = document.getElementById('confirmRejectButton');
        const cancelRejectButton = document.getElementById('cancelRejectButton');
        const rejectReason = document.getElementById('rejectReason');

        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());
            
            try {
                // Show loading indicator
                loadingIndicator.classList.remove('hidden');
                submitButton.disabled = true;

                const response = await fetch(form.action, {
                    method: form.method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formObject)
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 1500
                        }).then(() => {
                            window.location.href = '/admin/permintaan-unverified';
                            
                        });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: result.message
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Terjadi kesalahan',
                    text: 'Silakan coba lagi nanti.'
                });
            } finally {
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        rejectButton.addEventListener('click', function() {
            rejectModal.classList.remove('hidden');
        });

        cancelRejectButton.addEventListener('click', function() {
            rejectModal.classList.add('hidden');
        });

        confirmRejectButton.addEventListener('click', async function() {
            const reason = rejectReason.value.trim();
            if (!reason) {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal',
                    text: 'Alasan penolakan harus diisi.'
                });
                return;
            }

            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());
            formObject.rejectReason = reason;

            try {
                // Show loading indicator
                loadingIndicator.classList.remove('hidden');
                rejectButton.disabled = true;

                const response = await fetch('/admin/tolak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formObject)
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 1500
                        }).then(() => {
                            window.location.href = '/admin/permintaan-unverified';
                        });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: result.message
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: error,
                    text: 'Silakan coba lagi nanti.'
                });
            } finally {
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                rejectButton.disabled = false;
                rejectModal.classList.add('hidden');
            }
        });
    });
</script>